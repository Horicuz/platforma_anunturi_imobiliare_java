<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Adaugă / Editează Anunț</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body class="bg-light">

<div class="container mt-5 mb-5" style="max-width: 800px;">
    <div class="card shadow border-0">
        <div class="card-header bg-primary text-white py-3">
            <h4 class="mb-0">
                <i th:class="${modEditare} ? 'bi bi-pencil-square' : 'bi bi-house-add'"></i>
                <span th:text="${modEditare} ? 'Editează Anunț' : 'Adaugă Proprietate'"></span>
            </h4>
        </div>
        <div class="card-body p-4">

            <div th:if="${eroareImagine}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <span th:text="${eroareImagine}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <form th:action="${modEditare} ? '/anunturi/update/' + ${anunt.id} : '/anunturi/salveaza'"
                  method="post"
                  th:object="${anunt}"
                  enctype="multipart/form-data"
                  class="needs-validation" novalidate>

                <div th:if="${modEditare}" class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Modifici anunțul: <b th:text="*{titlu}"></b>
                </div>

                <h5 class="text-primary border-bottom pb-2 mb-3">1. Detalii Anunț</h5>

                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label class="fw-bold form-label">Titlu Anunț <span class="text-danger">*</span></label>
                        <input type="text" th:field="*{titlu}" class="form-control"
                               placeholder="Ex: Apartament 3 camere"
                               required minlength="5" maxlength="100"
                               th:classappend="${#fields.hasErrors('titlu')} ? 'is-invalid' : ''">
                        <div class="invalid-feedback">Titlul este obligatoriu (5-100 caractere).</div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <label class="fw-bold form-label">Preț (€) <span class="text-danger">*</span></label>
                        <input type="number" step="0.01" th:field="*{pret}" class="form-control"
                               required min="100" max="100000000"
                               th:classappend="${#fields.hasErrors('pret')} ? 'is-invalid' : ''">
                        <div class="invalid-feedback">Preț între 100 și 100 Mil €.</div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12 mb-3">
                        <label class="fw-bold form-label">Oraș <span class="text-danger">*</span></label>
                        <select th:field="*{localitate}" class="form-select" required
                                th:classappend="${#fields.hasErrors('localitate')} ? 'is-invalid' : ''">
                            <option value="">-- Alege Orașul --</option>
                            <option th:each="oras : ${toateOrasele}"
                                    th:value="${oras.id}"
                                    th:text="${oras.numeOras}"></option>
                        </select>
                        <div class="invalid-feedback">Selectați un oraș valid.</div>
                    </div>
                </div>

                <h5 class="text-primary border-bottom pb-2 mb-3 mt-4">2. Detalii Proprietate</h5>

                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Tip</label>
                        <select th:field="*{proprietate.tipProprietate}" class="form-select">
                            <option value="Apartament">Apartament</option>
                            <option value="Casa">Casă</option>
                            <option value="Garsoniera">Garsonieră</option>
                            <option value="Teren">Teren</option>
                        </select>
                    </div>

                    <div class="col-md-3 mb-3">
                        <label class="form-label">Nr. Camere <span class="text-danger">*</span></label>
                        <input type="number" th:field="*{proprietate.nrCamere}" class="form-control"
                               required min="1" max="100"
                               th:classappend="${#fields.hasErrors('proprietate.nrCamere')} ? 'is-invalid' : ''">
                        <div class="invalid-feedback">Între 1 și 100.</div>
                    </div>

                    <div class="col-md-3 mb-3">
                        <label class="form-label">Suprafață (mp) <span class="text-danger">*</span></label>
                        <input type="number" step="0.1" th:field="*{proprietate.suprafata}" class="form-control"
                               required min="1" max="100000"
                               th:classappend="${#fields.hasErrors('proprietate.suprafata')} ? 'is-invalid' : ''">
                        <div class="invalid-feedback">Max 100.000 mp.</div>
                    </div>

                    <div class="col-md-3 mb-3">
                        <label class="form-label">An Constr. <span class="text-danger">*</span></label>
                        <input type="number" th:field="*{proprietate.anConstruire}" class="form-control" placeholder="2020"
                               required min="1800" max="2030"
                               th:classappend="${#fields.hasErrors('proprietate.anConstruire')} ? 'is-invalid' : ''">
                        <div class="invalid-feedback">Între 1800-2030.</div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="fw-bold mb-2">Facilități:</label>
                    <div class="card p-3 bg-light border-0">
                        <div class="row">
                            <div class="col-md-4" th:each="fac : ${toateFacilitatile}">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" th:field="*{proprietate.facilitati}" th:value="${fac.id}">
                                    <label class="form-check-label" th:text="${fac.numeFacilitate}"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <h5 class="text-primary border-bottom pb-2 mb-3 mt-4">3. Multimedia & Descriere</h5>

                <div class="mb-3">
                    <label class="fw-bold form-label">Descriere Scurtă <span class="text-danger">*</span></label>
                    <textarea th:field="*{descriere}" rows="2" class="form-control" id="descriereInput"
                              required maxlength="75"
                              th:classappend="${#fields.hasErrors('descriere')} ? 'is-invalid' : ''"></textarea>

                    <div class="d-flex justify-content-between mt-1">
                        <div class="invalid-feedback">Descrierea este obligatorie.</div>
                        <small class="text-muted ms-auto"><span id="charCount">0</span> / 75 caractere</small>
                    </div>
                </div>

                <div class="mb-4 p-3 border rounded border-warning bg-white">
                    <label class="fw-bold mb-2"><i class="bi bi-images"></i> Gestionare Imagini</label>

                    <div th:if="${modEditare}" class="mb-3">
                        <p class="small text-muted mb-2">Imagini existente (Click pe X pentru a șterge):</p>

                        <div th:if="${anunt.imagini.isEmpty()}" class="text-muted fst-italic small">Nu există imagini încărcate.</div>

                        <div class="d-flex flex-wrap gap-2">
                            <div th:each="img : ${anunt.imagini}" class="position-relative border rounded p-1 bg-light">
                                <img th:src="@{'/uploads/' + ${img.url}}"
                                     style="width: 100px; height: 80px; object-fit: cover; border-radius: 4px;">

                                <a th:href="@{'/anunturi/sterge-poza/' + ${img.id}}"
                                   class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger text-decoration-none"
                                   onclick="return confirm('Sigur vrei să ștergi această poză?');"
                                   title="Șterge Poza">
                                    X
                                </a>
                            </div>
                        </div>
                        <hr>
                    </div>
                    <ul class="small text-muted mb-2">
                        <li>Poți adăuga poze noi care se vor alătura celor existente.</li>
                        <li>Maxim <b>5 poze</b> permise (Total).</li>
                    </ul>
                    <input type="file" name="fisierePoze" class="form-control" id="fileInput"
                           multiple accept="image/png, image/jpeg">
                    <div class="text-danger mt-2 small" id="fileError" style="display:none;">
                        <i class="bi bi-x-circle"></i> Ai selectat prea multe poze! Maximul este 5.
                    </div>
                </div>

                <div class="d-flex justify-content-between pt-3 border-top">
                    <a href="/anunturi" class="btn btn-secondary px-4">Anulează</a>
                    <button type="submit" class="btn btn-success btn-lg px-5 fw-bold">
                        <i class="bi bi-check-lg"></i> <span th:text="${modEditare} ? 'Salvează Modificările' : 'Publică Anunț'"></span>
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // 1. Validare Bootstrap
    (function () {
        'use strict'
        var forms = document.querySelectorAll('.needs-validation')
        Array.prototype.slice.call(forms)
            .forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }
                    form.classList.add('was-validated')
                }, false)
            })
    })()

    // 2. Contor Caractere
    const descInput = document.getElementById('descriereInput');
    const charCount = document.getElementById('charCount');
    if(descInput) {
        descInput.addEventListener('input', function() {
            const currentLength = this.value.length;
            charCount.textContent = currentLength;
            if(currentLength >= 75) {
                charCount.classList.add('text-danger', 'fw-bold');
            } else {
                charCount.classList.remove('text-danger', 'fw-bold');
            }
        });
    }

    // 3. Validare Numar Poze
    const fileInput = document.getElementById('fileInput');
    const fileError = document.getElementById('fileError');
    if(fileInput) {
        fileInput.addEventListener('change', function() {
            if (this.files.length > 5) {
                fileError.style.display = 'block';
                this.value = "";
                alert("Poți selecta maxim 5 poze! Te rugăm să selectezi din nou.");
            } else {
                fileError.style.display = 'none';
            }
        });
    }
</script>

</body>
</html>