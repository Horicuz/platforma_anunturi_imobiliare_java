<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Editare Profil</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Stiluri identice cu Register pentru consistenta */
        .is-valid { border-color: #198754 !important; background-image: none !important; }
        .is-invalid { border-color: #dc3545 !important; background-image: none !important; }
        .feedback-text { font-size: 0.8em; margin-top: 2px; }
        .text-danger { color: #dc3545; }
        .text-success { color: #198754; }
    </style>
</head>
<body class="bg-light d-flex align-items-center justify-content-center py-5" style="min-height: 100vh;">

<div class="card shadow" style="width: 600px;">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">‚úèÔ∏è Actualizare Date Personale</h5>
        <a href="/profil" class="btn btn-sm btn-light text-primary fw-bold">AnuleazƒÉ</a>
    </div>

    <div class="card-body p-4">
        <form action="/profil/update" method="post" th:object="${utilizator}" id="editForm" novalidate>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="fw-bold">Nume</label>
                    <input type="text" th:field="*{nume}" id="nume" class="form-control"
                           th:classappend="${eroareNume} ? 'is-invalid' : ''">
                    <div id="numeFeedback" class="feedback-text text-danger"></div>
                    <div class="invalid-feedback" th:if="${eroareNume}" th:text="${eroareNume}"></div>
                </div>
                <div class="col-md-6">
                    <label class="fw-bold">Prenume</label>
                    <input type="text" th:field="*{prenume}" id="prenume" class="form-control"
                           th:classappend="${eroarePrenume} ? 'is-invalid' : ''">
                    <div id="prenumeFeedback" class="feedback-text text-danger"></div>
                    <div class="invalid-feedback" th:if="${eroarePrenume}" th:text="${eroarePrenume}"></div>
                </div>
            </div>

            <div class="mb-3">
                <label class="fw-bold">Telefon (Op»õional)</label>
                <input type="text" th:field="*{telefon}" id="telefon" class="form-control"
                       placeholder="07xx..."
                       th:classappend="${eroareTelefon} ? 'is-invalid' : ''">

                <div id="telefonFeedback" class="feedback-text text-danger"></div>
                <div class="invalid-feedback" th:if="${eroareTelefon}" th:text="${eroareTelefon}"></div>
                <small class="text-muted">Format: 07xxxxxxxx (10 cifre)</small>
            </div>

            <div class="mb-3">
                <label class="text-muted small">Email (Nu se poate schimba)</label>
                <input type="text" th:field="*{email}" class="form-control bg-light" readonly>
            </div>

            <div class="mb-4" th:if="${utilizator.rol != 'ADMIN'}">
                <label class="form-label fw-bold">Rol utilizator</label>
                <div class="border rounded p-2 d-flex gap-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" th:field="*{rol}" value="CLIENT" id="cl">
                        <label class="form-check-label" for="cl">Client</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" th:field="*{rol}" value="AGENT" id="ag">
                        <label class="form-check-label" for="ag">Agent</label>
                    </div>
                </div>
            </div>

            <button type="submit" id="submitBtn" class="btn btn-success w-100 py-2">
                üíæ SalveazƒÉ ModificƒÉrile
            </button>
        </form>
    </div>
</div>

<script>
    // 1. SELECTARE ELEMENTE
    const inputs = {
        nume: document.getElementById('nume'),
        prenume: document.getElementById('prenume'),
        telefon: document.getElementById('telefon')
    };
    const submitBtn = document.getElementById('submitBtn');

    // 2. REGEX-URI (Aceleasi ca la Register)
    const regexNume = /^[a-zA-ZƒÉ√¢√Æ»ô»õƒÇ√Ç√é»ò»ö -]{3,20}$/;
    const regexTelefon = /^07[0-9]{8}$/;

    // 3. FUNCTIA DE VALIDARE
    function valideazaFormular() {
        // Validare Nume
        let validNume = valideazaCamp(inputs.nume, regexNume, "3-20 litere, fƒÉrƒÉ cifre.");
        // Validare Prenume
        let validPrenume = valideazaCamp(inputs.prenume, regexNume, "3-20 litere, fƒÉrƒÉ cifre.");

        // Validare Telefon (Special: Optional)
        let validTelefon = true;
        let valTel = inputs.telefon.value.trim();
        const feedbackTel = document.getElementById('telefonFeedback');

        if (valTel !== "") {
            if (!regexTelefon.test(valTel)) {
                inputs.telefon.classList.add('is-invalid');
                inputs.telefon.classList.remove('is-valid');
                feedbackTel.innerText = "Format invalid (Ex: 0722123456)";
                validTelefon = false;
            } else {
                inputs.telefon.classList.remove('is-invalid');
                inputs.telefon.classList.add('is-valid');
                feedbackTel.innerText = "";
                validTelefon = true;
            }
        } else {
            // Daca e gol, e valid (dar scoatem verdele ca sa nu fie strident)
            inputs.telefon.classList.remove('is-valid', 'is-invalid');
            feedbackTel.innerText = "";
            validTelefon = true;
        }

        // 4. BLOCARE / DEBLOCARE BUTON
        if (validNume && validPrenume && validTelefon) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('btn-secondary');
            submitBtn.classList.add('btn-success');
            submitBtn.innerHTML = "üíæ SalveazƒÉ ModificƒÉrile";
        } else {
            submitBtn.disabled = true;
            submitBtn.classList.add('btn-secondary');
            submitBtn.classList.remove('btn-success');
            submitBtn.innerHTML = "CorecteazƒÉ erorile...";
        }
    }

    // Helper validare camp simplu
    function valideazaCamp(input, regex, msg) {
        const val = input.value.trim();
        const feedback = document.getElementById(input.id + 'Feedback');

        if (!regex.test(val)) {
            input.classList.add('is-invalid');
            input.classList.remove('is-valid');
            if(feedback) feedback.innerText = msg;
            return false;
        } else {
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
            if(feedback) feedback.innerText = "";
            return true;
        }
    }

    // 5. ADAUGARE ASCULTATORI (Events)
    Object.values(inputs).forEach(input => {
        if(input) {
            input.addEventListener('input', valideazaFormular);
            input.addEventListener('blur', valideazaFormular);
        }
    });

    // 6. RULARE INITIALA (Pentru ca formularul e pre-completat)
    // Rulam validarea o data la incarcarea paginii ca sa coloram campurile corecte cu verde
    document.addEventListener('DOMContentLoaded', valideazaFormular);

</script>

</body>
</html>